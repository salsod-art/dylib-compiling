name: Build iOS dylib

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup MobileSubstrate header
        run: |
          mkdir -p include
          cat > include/substrate.h << 'EOF'
          #pragma once
          #ifdef __cplusplus
          extern "C" {
          #endif
          void MSHookFunction(void *symbol, void *replace, void **result);
          void *MSFindSymbol(void *image, const char *name);
          #ifdef __cplusplus
          }
          #endif
          EOF

      - name: Build dylib
        run: |
          SDK=$(xcrun --sdk iphoneos --show-sdk-path)

          clang++ -x objective-c++ xd_test.mm \
            -dynamiclib \
            -isysroot "$SDK" \
            -arch arm64 \
            -miphoneos-version-min=13.0 \
            -framework UIKit \
            -framework Foundation \
            -framework QuartzCore \
            -framework CoreGraphics \
            -framework AudioToolbox \
            -Iinclude \
            -fobjc-arc \
            -std=c++17 \
            -o EverLight.dylib

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: auto-build-${{ github.run_number }}
          name: Auto Build ${{ github.run_number }}
          files: EverLight.dylib
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
