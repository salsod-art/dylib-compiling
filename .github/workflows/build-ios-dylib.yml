name: Build iOS dylib (single .mm file)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Make build folders
        run: mkdir -p build/device build/simulator

      - name: Check Tweak.mm exists
        run: |
          if [ ! -f "Tweak.mm" ]; then
            echo "Put your source file named Tweak.mm in repo root"
            exit 1
          fi

      # DEVICE BUILD (real iPhone)
      - name: Build device dylib (iphone arm64)
        run: |
          SDK=$(xcrun --sdk iphoneos --show-sdk-path)

          xcrun --sdk iphoneos clang++ \
            -isysroot "$SDK" \
            -arch arm64 \
            -dynamiclib \
            -fobjc-arc \
            -framework Foundation \
            -framework UIKit \
            -install_name @rpath/libTweak.dylib \
            Tweak.mm \
            -o build/device/libTweak.dylib

          file build/device/libTweak.dylib
          ls -l build/device

      # SIMULATOR BUILD
      - name: Build simulator dylib
        run: |
          SIMSDK=$(xcrun --sdk iphonesimulator --show-sdk-path)

          xcrun --sdk iphonesimulator clang++ \
            -isysroot "$SIMSDK" \
            -arch x86_64 \
            -dynamiclib \
            -fobjc-arc \
            -framework Foundation \
            -framework UIKit \
            -install_name @rpath/libTweak.dylib \
            Tweak.mm \
            -o build/simulator/libTweak-x86_64.dylib

          xcrun --sdk iphonesimulator clang++ \
            -isysroot "$SIMSDK" \
            -arch arm64 \
            -dynamiclib \
            -fobjc-arc \
            -framework Foundation \
            -framework UIKit \
            -install_name @rpath/libTweak.dylib \
            Tweak.mm \
            -o build/simulator/libTweak-arm64.dylib || true

          # merge slices if possible
          lipo -create \
            build/simulator/libTweak-x86_64.dylib \
            build/simulator/libTweak-arm64.dylib \
            -output build/simulator/libTweak.dylib \
            || cp build/simulator/libTweak-x86_64.dylib build/simulator/libTweak.dylib

      - name: Upload dylibs
        uses: actions/upload-artifact@v4
        with:
          name: ios-dylib
          path: build/**
