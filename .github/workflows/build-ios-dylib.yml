name: Build iOS single-file dylib + XCFramework

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      lib_name:
        description: 'Base name for library (no prefix). e.g. mylib -> libmylib.dylib'
        required: false
        default: 'mylib'
      codesign_identity_secret:
        description: 'Optional: repo secret name with iOS signing identity string (e.g. IOS_CODESIGN_IDENTITY). Leave empty to skip codesign.'
        required: false
        default: ''

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write
    env:
      LIB_NAME: ${{ github.event.inputs.lib_name || 'mylib' }}
      CODESIGN_SECRET_NAME: ${{ github.event.inputs.codesign_identity_secret || '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare dirs
        run: |
          rm -rf build || true
          mkdir -p build/device build/simulator build/xcframework

      - name: Verify source exists
        run: |
          SRC="${{ env.LIB_NAME }}.c"
          if [ ! -f "$SRC" ]; then
            echo "Expected single source file '$SRC' in repo root. Create it and push."
            exit 1
          fi
          echo "Found $SRC"

      - name: Build device slice (iphoneos arm64)
        run: |
          SDK_PATH="$(xcrun --sdk iphoneos --show-sdk-path)"
          SRC="${{ env.LIB_NAME }}.c"
          OUT="build/device/lib${{ env.LIB_NAME }}.dylib"
          xcrun --sdk iphoneos clang -isysroot "$SDK_PATH" -arch arm64 -dynamiclib -fPIC -install_name @rpath/lib${{ env.LIB_NAME }}.dylib -o "$OUT" "$SRC" -O2 -stdlib=libc++
          file "$OUT" || true
          ls -l "$OUT"

      - name: Build simulator slices (x86_64 and arm64)
        run: |
          SIM_SDK="$(xcrun --sdk iphonesimulator --show-sdk-path)"
          SRC="${{ env.LIB_NAME }}.c"
          OUT_X86="build/simulator/lib${{ env.LIB_NAME }}-x86_64.dylib"
          OUT_ARM="build/simulator/lib${{ env.LIB_NAME }}-arm64.dylib"

          # x86_64 slice
          xcrun --sdk iphonesimulator clang -isysroot "$SIM_SDK" -arch x86_64 -dynamiclib -fPIC -install_name @rpath/lib${{ env.LIB_NAME }}.dylib -o "$OUT_X86" "$SRC" -O2 -stdlib=libc++
          # arm64 simulator slice (Apple Silicon runners)
          xcrun --sdk iphonesimulator clang -isysroot "$SIM_SDK" -arch arm64 -dynamiclib -fPIC -install_name @rpath/lib${{ env.LIB_NAME }}.dylib -o "$OUT_ARM" "$SRC" -O2 -stdlib=libc++ || true

          # merge available slices
          SIM_FINAL="build/simulator/lib${{ env.LIB_NAME }}.dylib"
          SLICES=""
          [ -f "$OUT_X86" ] && SLICES="$SLICES $OUT_X86"
          [ -f "$OUT_ARM" ] && SLICES="$SLICES $OUT_ARM"
          if [ -n "$SLICES" ]; then
            if [ $(echo "$SLICES" | wc -w) -gt 1 ]; then
              lipo -create -output "$SIM_FINAL" $SLICES
            else
              cp $SLICES "$SIM_FINAL"
            fi
            file "$SIM_FINAL" || true
            ls -l "$SIM_FINAL"
          else
            echo "No simulator slices produced."
          fi

      - name: Optionally codesign device dylib (uses secret)
        if: env.CODESIGN_SECRET_NAME != ''
        shell: bash
        env:
          CODESIGN_SECRET_NAME: ${{ env.CODESIGN_SECRET_NAME }}
        run: |
          ID="${{ secrets[env.CODESIGN_SECRET_NAME] || '' }}"
          DEVICE_LIB="build/device/lib${{ env.LIB_NAME }}.dylib"
          if [ -z "$ID" ]; then
            echo "Codesign identity secret not set or empty; skipping codesign."
            exit 0
          fi
          if [ ! -f "$DEVICE_LIB" ]; then
            echo "No device dylib to codesign."
            exit 0
          fi
          echo "Codesigning $DEVICE_LIB with '$ID'..."
          # --timestamp=none avoids network calls for runner signing; adjust if you want timestamping.
          codesign --force --sign "$ID" --timestamp=none "$DEVICE_LIB"
          codesign -v "$DEVICE_LIB" || true
          ls -l "$DEVICE_LIB"

      - name: Create XCFramework (device + simulator)
        run: |
          DEVICE_LIB="build/device/lib${{ env.LIB_NAME }}.dylib"
          SIM_LIB="build/simulator/lib${{ env.LIB_NAME }}.dylib"
          OUT_XC="build/${{ env.LIB_NAME }}.xcframework"
          rm -rf "$OUT_XC"
          args=""
          [ -f "$DEVICE_LIB" ] && args="$args -library $DEVICE_LIB"
          [ -f "$SIM_LIB" ] && args="$args -library $SIM_LIB"
          if [ -n "$args" ]; then
            xcodebuild -create-xcframework $args -output "$OUT_XC" || { echo "xcframework creation failed; continuing."; }
            ls -l "$OUT_XC" || true
          else
            echo "No inputs for XCFramework."
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-singlefile-artifacts
          path: |
            build/device/*.dylib
            build/simulator/*.dylib
            build/*.xcframework
